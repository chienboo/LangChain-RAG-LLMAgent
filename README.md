# RAG + Memory Demo 项目文档

## 📋 项目概述

这是一个基于 LangChain 的 RAG（Retrieval-Augmented Generation）系统演示项目，结合了文档检索和对话记忆功能。系统能够从文档中检索相关信息，并结合历史对话上下文生成回答。

## 🎯 当前实现功能

### 1. 核心功能模块

#### 1.1 LLM 模型加载 (`rag_chain.py:16-23`)
- **模型**: 使用阿里云 DashScope 的 `qwen-plus` 模型
- **配置**: 
  - Temperature: 0.3（控制输出随机性）
  - API 端点: DashScope 兼容模式
- **特点**: 支持 OpenAI 兼容接口

#### 1.2 文档加载与处理 (`rag_chain.py:25-36`)
- **文档加载**: 使用 `TextLoader` 加载 `docs/ifpc.txt` 文件
- **文档分割**: 
  - 使用 `RecursiveCharacterTextSplitter`
  - 块大小: 500 字符
  - 重叠: 100 字符
- **向量化存储**:
  - 嵌入模型: `sentence-transformers/all-MiniLM-L6-v2`
  - 向量库: FAISS（Facebook AI Similarity Search）
  - 实现高效的相似度检索

#### 1.3 RAG 链构建 (`rag_chain.py:38-61`)
- **Prompt 模板**:
  - 系统提示: 定义助手角色和行为准则
  - 历史消息占位符: 支持多轮对话上下文
  - 用户输入: 结合检索到的文档内容
- **链结构**:
  ```
  用户输入 → 文档检索 → 格式化文档 → Prompt → LLM → 输出解析
  ```
- **并行处理**: 使用 `RunnableParallel` 同时处理检索和输入

#### 1.4 对话记忆管理 (`rag_chain.py:64-77`)
- **存储方式**: 内存字典存储（`InMemoryChatMessageHistory`）
- **会话管理**: 基于 `session_id` 隔离不同用户的对话历史
- **集成**: 通过 `RunnableWithMessageHistory` 与 RAG 链集成

#### 1.5 Web 界面 (`app.py`)
- **框架**: Gradio
- **功能**: 
  - 聊天界面
  - 自动处理用户输入和系统响应
- **会话**: 固定会话 ID `user-001`

### 2. 技术栈

- **LangChain**: RAG 链和记忆管理框架
- **FAISS**: 向量相似度搜索
- **HuggingFace**: 文本嵌入模型
- **Gradio**: Web 界面框架
- **DashScope**: LLM API 服务

## ⚠️ 需要改进的点

### 🔴 高优先级（安全和稳定性）

#### 1. 安全性问题
- **API 密钥硬编码** (`rag_chain.py:22`)
  - **问题**: API 密钥直接写在代码中，存在泄露风险
  - **改进**: 
    - 使用环境变量（`.env` 文件）
    - 集成密钥管理服务（如 AWS Secrets Manager）
    - 添加 `.gitignore` 排除敏感文件

#### 2. 配置管理
- **硬编码配置** (`rag_chain.py:18-23, 30, 34, 40`)
  - **问题**: 模型参数、文件路径、Prompt 等硬编码
  - **改进**: 
    - 创建 `config.yaml` 或 `.env` 文件
    - 实现配置加载模块
    - 支持环境区分（dev/staging/prod）

#### 3. 错误处理
- **缺少异常处理**
  - **问题**: 无错误捕获机制，可能导致服务崩溃
  - **改进**: 
    - 添加 try-except 块
    - 实现优雅的错误处理
    - 返回友好的错误消息

#### 4. 持久化存储
- **内存存储限制** (`rag_chain.py:65`)
  - **问题**: 
    - 服务重启后对话历史丢失
    - 无法支持多进程/分布式部署
    - 内存占用随会话增长
  - **改进**: 
    - 抽象存储接口
    - 支持 Redis、PostgreSQL 等持久化存储
    - 实现存储适配器模式

### 🟡 中优先级（可维护性和扩展性）

#### 5. 代码组织
- **单文件结构**
  - **问题**: 所有逻辑集中在一个文件，难以维护
  - **改进**: 
    - 模块化拆分：
      - `config/`: 配置管理
      - `services/`: 业务逻辑（LLM、向量库、记忆）
      - `utils/`: 工具函数
      - `models/`: 数据模型
    - 实现依赖注入
    - 清晰的职责分离

#### 6. 向量存储抽象
- **FAISS 硬编码** (`rag_chain.py:35`)
  - **问题**: 无法切换其他向量库（Chroma、Pinecone、Weaviate 等）
  - **改进**: 
    - 定义向量存储抽象接口
    - 实现多种向量库适配器
    - 支持配置化选择

#### 7. 文档加载器扩展
- **单一加载器** (`rag_chain.py:26`)
  - **问题**: 仅支持文本文件，无法处理 PDF、Word、Markdown 等
  - **改进**: 
    - 实现加载器工厂模式
    - 支持多种文档格式
    - 自动识别文件类型

#### 8. Prompt 管理
- **硬编码 Prompt** (`rag_chain.py:39-43`)
  - **问题**: 
    - Prompt 修改需要改代码
    - 无法支持 A/B 测试
    - 无法动态切换 Prompt
  - **改进**: 
    - Prompt 模板文件化
    - 支持 Prompt 版本管理
    - 实现 Prompt 动态加载

### 🟢 低优先级（增强功能）

#### 9. 日志和监控
- **缺少日志系统**
  - **改进**: 
    - 结构化日志（`logging` 或 `structlog`）
    - 请求追踪（LangSmith 集成）
    - 性能监控（延迟、token 使用量）
    - 健康检查端点

#### 10. 测试覆盖
- **无测试代码**
  - **改进**: 
    - 单元测试（pytest）
    - 集成测试
    - Mock 外部依赖
    - CI/CD 集成

#### 11. 文档完善
- **缺少文档**
  - **改进**: 
    - API 文档（OpenAPI/Swagger）
    - 架构设计文档
    - 使用示例和教程
    - 代码注释和类型提示

#### 12. 依赖管理
- **版本未锁定** (`requirements.txt`)
  - **改进**: 
    - 锁定依赖版本
    - 使用 `poetry` 或 `pipenv`
    - 定期更新依赖

#### 13. 会话管理增强
- **固定会话 ID** (`app.py:7`)
  - **问题**: 所有用户共享同一会话
  - **改进**: 
    - 动态生成会话 ID
    - 会话过期机制
    - 会话清理策略

#### 14. 检索优化
- **基础检索** (`rag_chain.py:36`)
  - **改进**: 
    - 检索结果重排序（reranking）
    - 检索结果过滤
    - 多路检索融合
    - 检索参数可配置（top_k）

#### 15. 链的可扩展性
- **固定链结构** (`rag_chain.py:52-61`)
  - **改进**: 
    - 支持链组件动态组合
    - 中间件机制（如重试、缓存）
    - 链的可观测性

## 📊 改进优先级总结

| 优先级 | 改进项 | 影响范围 | 紧急程度 |
|--------|--------|----------|----------|
| 🔴 高 | API 密钥安全 | 安全 | 紧急 |
| 🔴 高 | 配置管理 | 可维护性 | 高 |
| 🔴 高 | 错误处理 | 稳定性 | 高 |
| 🔴 高 | 持久化存储 | 可用性 | 高 |
| 🟡 中 | 代码组织 | 可维护性 | 中 |
| 🟡 中 | 向量存储抽象 | 扩展性 | 中 |
| 🟡 中 | 文档加载器扩展 | 功能 | 中 |
| 🟡 中 | Prompt 管理 | 灵活性 | 中 |
| 🟢 低 | 日志和监控 | 可观测性 | 低 |
| 🟢 低 | 测试覆盖 | 质量保证 | 低 |
| 🟢 低 | 文档完善 | 协作 | 低 |

## 🚀 快速开始

### 安装依赖

```bash
pip install -r requirements.txt
```

### 配置环境变量

创建 `.env` 文件（当前未实现，需要改进）：

```env
DASHSCOPE_API_KEY=your_api_key_here
LLM_MODEL=qwen-plus
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
```

### 运行应用

```bash
python app.py
```

## 📝 注意事项

1. **当前版本为演示版本**，不适合生产环境使用
2. **API 密钥需要妥善保管**，不要提交到版本控制系统
3. **内存存储**仅适用于单机单进程场景
4. **文档路径**需要根据实际情况调整

## 🔄 版本历史

- **v0.1.0** (当前): 基础 RAG + Memory 功能实现

---

**最后更新**: 2024年

